# NeoVM 架构

## 概述

NeoVM 是一个基于栈的虚拟机，执行逻辑与区块链交互清晰分离。

## 核心组件

### 1. 执行引擎
- 加载和解析字节码
- 顺序执行指令
- 管理执行上下文
- 处理异常

### 2. 栈系统

NeoVM 使用多个栈进行操作：

#### 计算栈
所有计算的主要栈：
```
┌─────────────┐
│   栈顶      │  ← 最近压入
├─────────────┤
│   项目 2    │
├─────────────┤
│   项目 1    │
├─────────────┤
│   栈底      │  ← 最先压入
└─────────────┘
```

#### 备用栈
用于复杂操作期间的临时存储。

### 3. 调用栈

管理合约调用其他合约时的执行上下文：
```
┌─────────────────────┐
│  当前上下文          │  ← 活动执行
├─────────────────────┤
│  调用者上下文        │
├─────────────────────┤
│  原始上下文          │
└─────────────────────┘
```

## 数据类型

NeoVM 支持以下基本类型：

| 类型 | 描述 | 示例 |
|------|------|------|
| Boolean | 真/假 | `true`, `false` |
| Integer | 任意精度整数 | `12345`, `-999` |
| ByteString | 不可变字节数组 | `0x48656c6c6f` |
| Buffer | 可变字节数组 | 用于构建数据 |
| Array | 动态列表 | `[1, 2, 3]` |
| Struct | 值类型数组 | 赋值时复制 |
| Map | 键值对 | `{"key": "value"}` |
| InteropInterface | 外部对象 | 合约引用 |

## 执行上下文

每个执行上下文包含：

- **脚本** - 正在执行的字节码
- **指令指针** - 脚本中的当前位置
- **局部变量** - 函数级存储
- **静态字段** - 合约级存储
- **参数** - 传递给方法的参数

## 异常处理

Neo N3 引入了完整的异常处理：

```csharp
try
{
    // 可能抛出异常的代码
    SomeRiskyOperation();
}
catch (Exception e)
{
    // 处理异常
    Runtime.Log("发生错误");
}
finally
{
    // 始终执行
    Cleanup();
}
```

## 限制

| 参数 | 值 |
|------|-----|
| 最大栈大小 | 2048 项 |
| 最大项大小 | 1024 * 1024 字节 |
| 最大调用深度 | 1024 |
| 最大脚本长度 | 无限制（受 GAS 限制）|
